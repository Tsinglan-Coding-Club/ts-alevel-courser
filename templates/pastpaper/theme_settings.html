{% extends 'base.html' %}
{% load static %}

{% block title %}Theme Settings - Computer Science{% endblock %}

{% block extra_css %}
<style>
    .theme-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 30px;
    }

    .theme-card {
        border: 3px solid #dee2e6;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

    .theme-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .theme-card.active {
        border-color: #0d6efd;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
    }

    .theme-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .theme-name {
        font-size: 24px;
        font-weight: 600;
        margin: 0;
    }

    .theme-badge {
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }

    .color-palette {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .color-swatch {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        border: 2px solid #dee2e6;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #666;
        font-weight: 500;
    }

    .color-swatch .color-code {
        margin-top: 5px;
        font-family: monospace;
        font-size: 10px;
    }

    .theme-preview {
        margin-top: 20px;
        padding: 20px;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .preview-elements {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .preview-btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        cursor: default;
    }

    .page-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 10px;
        color: #212529;
    }

    .page-subtitle {
        color: #6c757d;
        margin-bottom: 40px;
    }

    .save-info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        padding: 15px;
        margin-top: 30px;
        color: #0c5460;
    }

    .check-icon {
        color: #28a745;
        font-size: 24px;
        margin-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="theme-container">
    <h1 class="page-title">Theme Settings</h1>
    <p class="page-subtitle">Choose your preferred color scheme for the interface</p>

    <div id="themes-container">
        <!-- Themes will be dynamically loaded here -->
    </div>

    <div class="save-info">
        <i class="bi bi-info-circle"></i>
        Your theme preference will be saved locally in your browser and applied automatically on your next visit.
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let themesData = {};

    // Load themes from JSON and render
    document.addEventListener('DOMContentLoaded', async function() {
        await loadThemes();
        const currentTheme = localStorage.getItem('colorTheme') || 'default';
        updateActiveTheme(currentTheme);
    });

    async function loadThemes() {
        try {
            const response = await fetch('{% static "js/themes.json" %}');
            themesData = await response.json();
            renderThemes();
        } catch (error) {
            console.error('Error loading themes:', error);
        }
    }

    function renderThemes() {
        const container = document.getElementById('themes-container');
        container.innerHTML = '';

        Object.keys(themesData).forEach(themeKey => {
            const theme = themesData[themeKey];
            const themeCard = createThemeCard(themeKey, theme);
            container.appendChild(themeCard);
        });
    }

    function createThemeCard(themeKey, theme) {
        const card = document.createElement('div');
        card.className = 'theme-card';
        card.setAttribute('data-theme', themeKey);
        card.onclick = () => selectTheme(themeKey);

        // Create gradient background for the card preview
        const bgGradient = `linear-gradient(135deg, ${theme.colors.bgGradientStart} 0%, ${theme.colors.bgGradientEnd} 100%)`;

        card.innerHTML = `
            <div class="theme-header">
                <h3 class="theme-name">${theme.name}</h3>
                <span class="theme-badge text-white" style="background: ${theme.badgeColor};">${theme.badge}</span>
            </div>
            <div class="color-palette">
                ${theme.palette.map(color => `
                    <div class="color-swatch" style="background: ${color.color}; color: ${isLightColor(color.color) ? '#000' : '#fff'};">
                        <span>${color.name}</span>
                        <span class="color-code">${color.color}</span>
                    </div>
                `).join('')}
            </div>
            <div class="theme-preview" style="background: ${bgGradient};">
                <p style="color: ${theme.colors.textColor};"><strong>Preview:</strong></p>
                <div class="preview-elements">
                    <button class="preview-btn" style="background: ${theme.colors.floatButtonColor}; color: ${isLightColor(theme.colors.floatButtonColor) ? '#000' : '#fff'};">Float Button</button>
                    <button class="preview-btn" style="background: ${theme.colors.backButtonColor}; color: white;">Back Button</button>
                    <button class="preview-btn" style="background: ${theme.colors.pdfButtonSuccess}; color: white;">PDF Button</button>
                </div>
                <div style="margin-top: 10px; padding: 8px 12px; background: ${theme.colors.selectionPanelHeaderColor}; border-radius: 4px; margin-bottom: 6px;">
                    <span style="color: white; font-size: 12px; font-weight: 600;">Selection Panel Header</span>
                </div>
                <div style="margin-top: 6px; padding: 8px 12px; background: ${theme.colors.pdfPanelHeaderColor}; border-radius: 4px; margin-bottom: 6px;">
                    <span style="color: white; font-size: 12px; font-weight: 600;">PDF Panel Header</span>
                </div>
                <div style="padding: 10px; background: linear-gradient(135deg, ${theme.colors.navbarGradientStart} 0%, ${theme.colors.navbarGradientEnd} 100%); border-radius: 4px;">
                    <span style="color: white; font-size: 12px;">Navbar Gradient</span>
                </div>
            </div>
        `;

        return card;
    }

    function isLightColor(color) {
        // Convert hex to RGB
        const hex = color.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);

        // Calculate luminance
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return luminance > 0.5;
    }

    function selectTheme(themeName) {
        // Save to localStorage
        localStorage.setItem('colorTheme', themeName);

        // Update active state
        updateActiveTheme(themeName);

        // Apply theme immediately
        applyTheme(themeName);

        // Show confirmation
        showConfirmation();
    }

    function updateActiveTheme(themeName) {
        // Remove active class from all
        document.querySelectorAll('.theme-card').forEach(card => {
            card.classList.remove('active');
        });

        // Add active class to selected
        const selectedCard = document.querySelector(`[data-theme="${themeName}"]`);
        if (selectedCard) {
            selectedCard.classList.add('active');
        }
    }

    function applyTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        document.body.setAttribute('data-theme', themeName);

        // Apply theme CSS variables immediately
        if (themesData[themeName]) {
            applyThemeVariables(themesData[themeName].colors);
        }
    }

    function applyThemeVariables(colors) {
        const root = document.documentElement;
        root.style.setProperty('--navbar-gradient-start', colors.navbarGradientStart);
        root.style.setProperty('--navbar-gradient-end', colors.navbarGradientEnd);
        root.style.setProperty('--float-button-color', colors.floatButtonColor);
        root.style.setProperty('--float-button-hover', colors.floatButtonHover);
        root.style.setProperty('--nav-button-color', colors.navButtonColor);
        root.style.setProperty('--nav-button-hover', colors.navButtonHover);
        root.style.setProperty('--back-button-color', colors.backButtonColor);
        root.style.setProperty('--back-button-hover', colors.backButtonHover);
        root.style.setProperty('--selection-panel-header-color', colors.selectionPanelHeaderColor);
        root.style.setProperty('--pdf-panel-header-color', colors.pdfPanelHeaderColor);
        root.style.setProperty('--pdf-button-primary', colors.pdfButtonPrimary);
        root.style.setProperty('--pdf-button-success', colors.pdfButtonSuccess);
        root.style.setProperty('--pdf-button-info', colors.pdfButtonInfo);
        root.style.setProperty('--pdf-button-warning', colors.pdfButtonWarning);
        root.style.setProperty('--pdf-button-danger', colors.pdfButtonDanger);
        root.style.setProperty('--pdf-button-secondary', colors.pdfButtonSecondary);
        root.style.setProperty('--question-completed-bg', colors.questionCompletedBg);
        root.style.setProperty('--question-completed-border', colors.questionCompletedBorder);
        root.style.setProperty('--question-saved-bg', colors.questionSavedBg);
        root.style.setProperty('--question-saved-border', colors.questionSavedBorder);
        root.style.setProperty('--bg-gradient-start', colors.bgGradientStart);
        root.style.setProperty('--bg-gradient-end', colors.bgGradientEnd);
        root.style.setProperty('--text-color', colors.textColor);
        root.style.setProperty('--button-text-color', colors.buttonTextColor);
        root.style.setProperty('--card-bg', colors.cardBg);
        root.style.setProperty('--card-border', colors.cardBorder);
    }

    function showConfirmation() {
        const saveInfo = document.querySelector('.save-info');
        const originalHTML = saveInfo.innerHTML;

        saveInfo.innerHTML = '<i class="bi bi-check-circle-fill check-icon"></i> Theme saved successfully! It will be applied across all pages.';
        saveInfo.style.background = '#d4edda';
        saveInfo.style.borderColor = '#c3e6cb';
        saveInfo.style.color = '#155724';

        setTimeout(() => {
            saveInfo.innerHTML = originalHTML;
            saveInfo.style.background = '#d1ecf1';
            saveInfo.style.borderColor = '#bee5eb';
            saveInfo.style.color = '#0c5460';
        }, 3000);
    }
</script>
{% endblock %}
